name: Notarize Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to upload notarized assets to (for example: v0.2.1)"
        required: true
      run_release_final:
        description: "Run make release-final before notarization"
        required: false
        default: "true"

jobs:
  notarize:
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      OPSCINEMA_TAURI_BUNDLES: app,dmg
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      MACOS_CERT_BASE64: ${{ secrets.MACOS_CERT_BASE64 }}
      MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
      MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve tag and validate secrets
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
          else
            TAG_NAME="${{ inputs.tag_name }}"
          fi
          if [ -z "${TAG_NAME}" ]; then
            echo "::error::tag_name is required for workflow_dispatch."
            exit 1
          fi
          for key in APPLE_ID APPLE_TEAM_ID APPLE_APP_SPECIFIC_PASSWORD MACOS_CERT_BASE64 MACOS_CERT_PASSWORD MACOS_SIGNING_IDENTITY; do
            if [ -z "${!key:-}" ]; then
              echo "::error::Missing required secret: ${key}"
              exit 1
            fi
          done
          echo "tag_name=${TAG_NAME}" >> "${GITHUB_OUTPUT}"
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install UI deps
        run: npm --prefix apps/desktop/ui ci
      - name: Install tauri-cli
        run: cargo install tauri-cli --locked
      - name: Run release checks (optional)
        if: ${{ github.event_name == 'release' || inputs.run_release_final == 'true' }}
        run: make release-final
      - name: Build bundle artifacts
        run: make package-bundle
      - name: Sign and notarize artifacts
        id: notarize
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH="$(find target/debug/bundle/macos -maxdepth 1 -name '*.app' | head -n1)"
          DMG_PATH="$(find target/debug/bundle/dmg -maxdepth 1 -name '*.dmg' | head -n1)"
          if [ -z "${APP_PATH}" ] || [ -z "${DMG_PATH}" ]; then
            echo "::error::Could not locate .app/.dmg bundle outputs."
            exit 1
          fi

          KEYCHAIN_PASSWORD="$(uuidgen)"
          security create-keychain -p "${KEYCHAIN_PASSWORD}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" build.keychain
          security set-keychain-settings -lut 21600 build.keychain

          echo "${MACOS_CERT_BASE64}" | base64 --decode > signing-cert.p12
          security import signing-cert.p12 -k build.keychain -P "${MACOS_CERT_PASSWORD}" -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/xcrun
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${KEYCHAIN_PASSWORD}" build.keychain

          codesign --force --deep --options runtime --timestamp --sign "${MACOS_SIGNING_IDENTITY}" "${APP_PATH}"
          codesign --verify --deep --strict --verbose=2 "${APP_PATH}"

          xcrun notarytool submit "${DMG_PATH}" \
            --apple-id "${APPLE_ID}" \
            --team-id "${APPLE_TEAM_ID}" \
            --password "${APPLE_APP_SPECIFIC_PASSWORD}" \
            --wait

          xcrun stapler staple "${APP_PATH}"
          xcrun stapler staple "${DMG_PATH}"

          APP_ZIP="$(dirname "${APP_PATH}")/$(basename "${APP_PATH}" .app).zip"
          ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "${APP_ZIP}"
          shasum -a 256 "${APP_ZIP}" "${DMG_PATH}"

          {
            echo "app_zip_path<<EOF"
            echo "${APP_ZIP}"
            echo "EOF"
            echo "dmg_path<<EOF"
            echo "${DMG_PATH}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"
      - name: Upload notarized build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: notarized-macos-assets-${{ steps.prep.outputs.tag_name }}
          path: |
            ${{ steps.notarize.outputs.app_zip_path }}
            ${{ steps.notarize.outputs.dmg_path }}
      - name: Upload notarized assets to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ steps.prep.outputs.tag_name }}" \
            "${{ steps.notarize.outputs.app_zip_path }}#$(basename "${{ steps.notarize.outputs.app_zip_path }}")" \
            "${{ steps.notarize.outputs.dmg_path }}#$(basename "${{ steps.notarize.outputs.dmg_path }}")" \
            --clobber \
            --repo "${GITHUB_REPOSITORY}"
